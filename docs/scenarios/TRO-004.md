# TRO-004: The Composite Ghost

- **ID:** TRO-004
- **Category:** Defense Evasion Concepts
- **MITRE ATT&CK Mapping:** [T1036 - Masquerading](https://attack.mitre.org/techniques/T1036/) / [T1200 - Hardware Additions](https://attack.mitre.org/techniques/T1200/)

---

## ðŸ“– Description

This scenario researches **Composite Device** profiles. By default, a USB device typically presents a single interface (e.g., Keyboard). A composite device presents multiple independent interfaces over a single physical connection (e.g., Keyboard + Serial + Mass Storage). This research explores how security software (EDR/AV) logs these multiple "identities" and whether it can correlate behaviors across different USB classes originating from the same physical port.

## ðŸŽ¯ Attack Objective

Analyze the "blind spots" of security monitoring when a single physical device presents multiple logical identities. Test if alerting on "New HID Keyboard" is bypassed if the device is first registered as a "USB Serial Port" or "Prototyping Device."

## ðŸ‘¥ Threat Model

- **Sophisticated Adversary:** An attacker using custom firmware to blend in with authorized peripherals (like a docking station or specialized industrial controller).
- **Researcher:** Exploring the boundaries of USB stack monitoring in modern operating systems.

## ðŸ› ï¸ Requirements

- **Hardware:** Teensy 4.1 (Ideal for memory/composite complexity)
- **OS Environment:** Windows 11, Linux (Latest Kernel)
- **Software:** Teensyduino with `USB Type` set to `Serial + Keyboard + Mouse + Joystick`.

---

## ðŸ”„ High-Level Flow

1. **Device Insertion:** Teensy insertion.
2. **Enumeration:** The host enumerates multiple interfaces:
    - Interface 0: USB Serial (COM port)
    - Interface 1: HID Keyboard
    - Interface 2: HID Mouse
3. **Triggered Behavior:** The "Serial" interface is used to send configuration signals to the Teensy, which then triggers "Keyboard" HID interactions.
4. **Data Correlation Test:** Check if EDR logs the Serial connection and the Keyboard input as part of the same "Event Chain."

---

## ðŸ“ˆ Detection Surface

### Host-Level Logs

- **Windows Event ID 20001 (Device Setup):** Records the installation of the composite parent device.
- **PNP Activity Logs:** Monitoring for multiple `DeviceInstanceId` entries appearing simultaneously under the same parent USB hub port.

### Behavioral Indicators

- **Composite Parent Discrepancy:** A single USB port (Hub/Port ID) spawning 3+ different device classes within milliseconds.
- **Cross-Interface Activity:** Serial traffic immediately followed by automated HID input.

---

## ðŸ›¡ï¸ Mitigation & Controls

- **Interface Blocking:** Use specialized software to block specific USB classes (e.g., block Serial but allow Keyboard) even on composite devices.
- **Port Correlation:** Advanced EDRs should correlate events by Physical Port ID (available in Windows SetupAPI logs).
- **Zero Trust Hardware:** Treating every new USB device registration as untrusted, regardless of its reported class.

---

## âš–ï¸ Legal & Ethical Notice
>
> [!IMPORTANT]
> Researching USB stack vulnerabilities is a sensitive area. Never perform these tests on systems running critical production workloads.

---

**Author:** Ismail Tasdelen
**Updated:** 2026-01-01
